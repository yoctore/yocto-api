<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>app/routes/controller.js - yocto-api</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="yocto-api" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/ControllerModels.html">ControllerModels</a></li>
                                <li><a href="../classes/ControllerRoutes.html">ControllerRoutes</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: app/routes/controller.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

var joi         = require(&#x27;joi&#x27;);
var _           = require(&#x27;lodash&#x27;);
var logger      = require(&#x27;yocto-logger&#x27;);
var express     = require(&#x27;express&#x27;);
var models      = require(&#x27;../models/controller.js&#x27;);
var dm          = require(&#x27;../defaultMessage.js&#x27;);
var routes      = require(&#x27;./routes.json&#x27;);

/**
* List of all default property in a mongodb document
*yoct
* @property {Array} DEFAULT_PROP_MONGODB
* @default [ &#x27;__v&#x27;, &#x27;_id&#x27;]
*/
var DEFAULT_PROP_MONGODB = [ &#x27;__v&#x27;, &#x27;_id&#x27; ];

//Define a Joi schema for test if route have a goodformat
var routeJoiSchema = joi.object().keys({
  path            : joi.string().required(),
  alias           : joi.array().items(joi.string()),
  model           : joi.string().required(),
  paramToRetrieve : joi.array().items(joi.string()),
  requestExcluded : joi.array().items(joi.string())
});

/**
* Yocto API : Routes Controller
*
* Controller of routes based on Express
*
* It read a jsonfile and create each route
*
* For more details on these dependencies read links below :
* - LodAsh : https://lodash.com/
* - yocto-logger : git+ssh://lab.yocto.digital:yocto-node-modules/yocto-utils.git
* - express : http://expressjs.com/
* - joi : https://github.com/hapijs/joi#array
*
*
* @date : 11/05/2015
* @author : Cedric Balard &lt;cedric@yocto.re&gt;
* @copyright : Yocto SAS, All right reserved
* @class ControllerRoutes
*/
function Controller() {

  /**
  * List of all http request
  *
  * @property {Array} ALL_HTTP_REQUESTS
  * @default [ &#x27;post&#x27;, &#x27;get&#x27;, &#x27;put&#x27;, &#x27;patch&#x27;, &#x27;delete&#x27;, &#x27;head&#x27;]
  */
  this.ALL_HTTP_REQUESTS = [ &#x27;post&#x27;, &#x27;get&#x27;, &#x27;put&#x27;, &#x27;patch&#x27;, &#x27;delete&#x27;, &#x27;head&#x27; ];

  /**
  * Model&#x27;s Controller, is the controller that will use to retrieve a model
  *
  * @property {Object} models
  * @default require &#x27;../models/controller.js&#x27;
  */
  this.models = models;

  /**
  * The main router
  *
  * @property {Object} router
  * @default require &#x27;../models/controller.js&#x27;
  */
  this.router = express();

}

/**
* Test if string is defined &lt;/br&gt;
* Used to dertermine if we call find() or findById()
*
* @method getFn
* @param {Object} varToTest the var to test
* @return {String} return &#x27;find&#x27; if varToTest is undefined, otherwise &#x27;findById&#x27;
*/
Controller.prototype.getFn = function(varToTest) {

  if (_.isUndefined(varToTest)) {
    return &#x27;find&#x27;;
  }
  return &#x27;findById&#x27;;
};

/**
* Implement the http request : GET &lt;/br&gt;
* Get an object &lt;/br&gt;
* Send a error to the client if the request failed, otherwise a json file to the client with the data requested
*
* @method get
* @param  {Object} model the data model object
* @param  {String} path the root path
* @param  {String} paramToGet The property to retrieve on url
*/
Controller.prototype.get = function(model, path, paramToGet) {

  // Determine if paramToGet is not empty, and get good function name
  var fn = this.getFn(paramToGet);

  // Add methode get to the route
  this.router.get(path, function(req, res) {

    logger.info(&#x27;[ ControllerRoutes.get ] - revceiving request, route is : &#x27; + path);

    //Find
    model[fn](req.params[paramToGet], function(err, val) {

      if (err) {
        res.send(err);
      }

      //Succes so Send a jsonfile
      res.json(val);
    });
  });
};

/**
* Implement the http request : HEAD &lt;/br&gt;
* Get a head of object &lt;/br&gt;
* Send a error to the client if the request failed, otherwise a header will be sent
*
* @method head
* @param  {Object} model the data model object
* @param  {String} path the root path
* @param  {String} paramToGet The property to retrieve on url
*/
Controller.prototype.head = function(model, path, paramToGet) {

  // Determine if paramToGet is not empty, and get good function name
  var fn = this.getFn(paramToGet);

  // Add methode head to the route
  this.router.head(path, function(req, res) {

    logger.info(&#x27;[ ControllerRoutes.head ] - revceiving request, route is : &#x27; + path);

    // Find
    model[fn](req.params[paramToGet], function(err, val) {

      if (err) {
        res.send(err);
      }

      //Succes so send success
      res.status(200).send(&#x27;OK&#x27;);
    });
  });
};

/**
* Implement the http request : POST &lt;/br&gt;
* Add a new Object in DB &lt;/br&gt;
* Send a error to the client if the request failed, otherwise a json file to the client with the data
*
* @method post
* @param  {Object} Model the data model object (Model start with an uppercase for jshint validation)
* @param  {String} path the root path
*/
Controller.prototype.post = function(Model, path) {

  //Save the scope
  var scope = this;

  // Add methode post to the route
  this.router.post(path, function(req, res) {

    logger.info(&#x27;[ ControllerRoutes.post ] - revceiving request, route is : &#x27; + path);

    //Create a instance of model, used to save in db
    var obj = new Model();

    //Retrieve all property of the object in the current model, and omit default property of mongodb
    _.each(_.omit(Model.schema.paths, DEFAULT_PROP_MONGODB), function(val, key) {

      //Add the propriety to the new object
      obj[key] = req.body[key];

      //Add a validation step for model
      scope.checkModelValidation(val, obj, key);
    });

    //Save object in db
    obj.save(function(err) {

      if (err) {
        res.send(err);
      }
      //Succes so Send a jsonfile
      res.json(dm.success);
    });
  });
};

/**
* Implement the http request : PUT &lt;/br&gt;
* Update an object in integrallity &lt;/br&gt;
* Send a error to the client if the request failed, otherwise a json file to the client with the data
*
* @method put
* @param  {Object} model the data model object
* @param  {String} path the root path
* @param  {String} paramToGet The property to retrieve on url to update the object
*/
Controller.prototype.put = function(model, path, paramToGet) {

  //Save the scope
  var scope = this;

  // Add methode update to the route
  this.router.put(path, function(req, res) {

    logger.info(&#x27;[ ControllerRoutes.put ] - revceiving request, route is : &#x27; + path);
    if (_.isEmpty(paramToGet)) {
      res.status(400).send(&#x27;Id not defined&#x27;);
      return;
    }

    //Find
    model.findById(req.params[paramToGet], function(err, value) {

      if (err) {
        res.send(err);
      }

      //Retrieve all property of the object in the current model, and omit default property of mongodb
      _.each(_.omit(model.schema.paths, DEFAULT_PROP_MONGODB), function(val, key) {

        value[key] = req.body[key];

        //Add a validation step for model
        scope.checkModelValidation(val, value, key);
      });

      // save the user and check for errors
      value.save(function(err) {

        if (err) {
          res.send(err);
        }

        //Succes so Send a jsonfile
        res.json(dm.success);
      });
    });
  });
};

/**
 * Check if the parameter should not be empty &lt;/br&gt;
 * And if it&#x27;s the case, add a validation step into mongoose
 *
 * @method checkModelValidation
 * @param {Object} val the value
 * @param {Object} value the object
 * @param {String} key the key of the value
 */
Controller.prototype.checkModelValidation = function(val, value, key) {

  //Add a validation step for model
  if (!_.isUndefined(val.caster)) {
    if (!_.isUndefined(val.caster.isRequired)) {

      //Add a validation step for model
      value.schema.path(key).validate(function(valueToUpdate) {

        //test if the var is empty, and return false to show that the validation failed
        if (_.isEmpty(_.compact(valueToUpdate))) {
          return false;
        }
      });
    }
  }

};

/**
* Implement the http request : PATCH &lt;/br&gt;
* Update an object partialy &lt;/br&gt;
* Send a error to the client if the request failed, otherwise a json file to the client with the data
*
* @method patch
* @param  {Object} model the data model object
* @param  {String} path the root path
* @param  {String} paramToGet The property to retrieve on url to update the object
*/
Controller.prototype.patch = function(model, path, paramToGet) {

  //Update user
  this.router.patch(path, function(req, res) {

    logger.info(&#x27;[ ControllerRoutes.patch ] - revceiving request, route is : &#x27; + path);
    if (_.isEmpty(paramToGet)) {
      res.status(400).send(&#x27;Id not defined&#x27;);
      return;
    }

    //Find
    model.findById(req.params[paramToGet], function(err, val) {

      if (err) {
        res.send(err);
      }

      //read each key, and update the model to save it on db
      _.each(req.body, function(value, key) {

        //Assign value
        val[key] = value;
      });

      // save the user and check for errors
      val.save(function(err) {

        if (err) {
          res.send(err);
        }
        res.json(dm.success);
      });
    });
  });
};

/**
* Implement the http request : DELETE &lt;/br&gt;
* Delete an object &lt;/br&gt;
* Send a error to the client if the request failed, otherwise a json file to the client with the data
*
* @method delete
* @param  {Object} model the data model object
* @param  {String} path the root path
* @param  {String} paramToGet The property to retrieve on url to delete the object
*/
Controller.prototype.delete = function(model, path, paramToGet) {

  //Update user
  this.router.delete(path, function(req, res) {

    logger.info(&#x27;[ ControllerRoutes.delete ] - revceiving request, route is : &#x27; + path);

    if (_.isEmpty(paramToGet)) {
      res.status(400).send(&#x27;Id not defined&#x27;);
      return;
    }

    model.remove({_id: req.params[paramToGet]}, function(err, user) {

      if (err) {
        res.send(err);
      }
      res.json(dm.success);
    });
  });
};

/**
* Add a route to the main router
*
* @method addRoute
* @param {String} path route to add
* @param {String} nameModel name of the model object to retrieve into the controller of model
* @param {Array} reqExcluded array of excluded request
* @param {String} paramToRetrieve name of the param to retrieve
*/
Controller.prototype.addRoute = function(path, nameModel, reqExcluded, paramToRetrieve) {

  logger.info(&quot;[ ControllerRoutes.addRoute ] - new route found, path : &quot; + path);

  //retrieve the model
  var model = this.models.getModel(nameModel);

  //check if model is not false
  if (model !== false) {
    logger.info(&quot;[ ControllerRoutes.addRoute ] - adding new route, path : &quot; + path);

    //Handle wich requests are implemented
    //Retrieve the difference betwenn ALL_HTTP_REQUESTS and all requests excluded
    _.each( _.difference(this.ALL_HTTP_REQUESTS, reqExcluded), function(fn) {

      //Call function by his name
      this[fn](model, path, paramToRetrieve);
    }, this);

    return true;
  }

  logger.warning( &#x27;[ ControllerRoutes.addRoute ] - can\&#x27;t add route : \&#x27;&#x27; + path + &#x27;\&#x27; ,because model is not defined&#x27;);
  return false;
};

/**
* Add a middleware
*
* @method addMidlleware
*/
Controller.prototype.addMidlleware = function() {

  this.router.use(function(req, res, next) {

    next(); // make sure we go to the next routes and don&#x27;t stop here
  });
};

/**
* Initialise the controller &lt;/br&gt;
* Retrieve all routes and thoose alias and add there into router
*
* @method init
*/
Controller.prototype.init = function() {
  logger.info(&#x27;[ ControllerRoutes.init ] - start&#x27;);

  //Init models Controller
  this.models.init();

  //Ass middleware
  this.addMidlleware();

  // read json file and add routes
  _.each(routes.routes, function(route) {

    //Execute the joi vailidation
    var result = routeJoiSchema.validate(route);

    //Check if have no error in joi validation
    if (_.isEmpty(result) || _.isEmpty(result.error)) {

      //create a array that contains the main route, and all thoose aliases
      var routeAndAlias = [];
      routeAndAlias.push(route.path);

      if (!_.isEmpty(route.alias)) {
        routeAndAlias.push(route.alias);
        routeAndAlias = _.flatten(routeAndAlias);
      }

      //add Main route
      _.each(routeAndAlias, function(val) {
        this.addRoute(val, route.model, route.requestExcluded, route.paramToRetrieve);
      }, this);

    } else {
      logger.error(&#x27;[ ControllerRoutes.init ] - error when trying to add a new route, please check the file : \&#x27;routes.json\&#x27;&#x27;);

      //log each error
      _.forEach(result.error.details, function(val) {

          logger.warning(&#x27;[ ControllerRoutes.initP ] - &#x27; + val.message + &#x27; at &#x27; + val.path);
      });
    }
  }, this);
};

/**
* Export current Controller to use it on node
*/
module.exports = new (Controller)();

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
