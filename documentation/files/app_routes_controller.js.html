<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>app/routes/controller.js - yocto-api</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="yocto-api" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/yoctoRouter.html">yoctoRouter</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: app/routes/controller.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
var _           = require(&#x27;lodash&#x27;);
var logger      = require(&#x27;yocto-logger&#x27;);

var yoctoRouter = require(&#x27;../../yoctoRouter.js&#x27;);
var dm          = require(&#x27;../defaultMessage.js&#x27;);
var routes      = require(&#x27;./routes.json&#x27;);
var models  = require(&#x27;../models/controller.js&#x27;);

var tabRouter = [] ;


/**
 * Get model from models.json by call the model controller
 *
 * @param {[type]} nameModel [description]
 */
var getModel = function(nameModel) {

  return models[_.findIndex(models, { &#x27;name&#x27;: nameModel })].mongooseModel;
};


var reqGet = function(model, newRouter, indParamToGet) {
  newRouter.addGet(function(req, res) {

    if( _.isUndefined(indParamToGet)) {
      model.find(req.params[indParamToGet], function(err, val) {
        if (err) {
          res.send(err);
        }
        res.json(val);
      });
    } else {
      model.findById(req.params[indParamToGet], function(err, val) {
        if (err) {
          res.send(err);
        }
        res.json(val);
      });
    }

  });
};


var reqHead = function(model, newRouter, indParamToGet) {

  newRouter.addHead( function(req, res) {

    console.log(&#x27;[ HEAD ]&#x27;);

    if( _.isUndefined(indParamToGet)) {

      model.find(function(err, val) {

        if (err) {
          res.send(err);
        }
        res.status(200).send(&#x27;OK&#x27;);
      });
    } else {

      model.findById(function(err, val) {
        if (err) {
          res.send(err);
        }
        res.status(200).send(&#x27;OK&#x27;);
      });
    }
  });
};


var reqPost = function(model, newRouter) {
  newRouter.addPost(function(req, res) {

    console.log(&#x27;[ POST ] &#x27;);


    //Create a instance of model, used to save in db
    var obj  = new model();

    //Retrieve all property of the object in the current model
    _.each( model.schema.paths, function(val, key) {

      // test if key doesn&#x27;t start with &#x27;_&#x27; like &#x27;_id&#x27; or &#x27;__v&#x27;
      if(! _.startsWith(key, &#x27;_&#x27;)) {
        obj[key] = req.body[key];
      }
    });

    obj.save(function(err) {

      if (err) {
        res.send(err);
      }
      res.json(dm.userCreatedSucces);
    });

  });
};

var reqPut = function(model, newRouter, indParamToGet) {
  //Update user
  newRouter.addPut(function(req, res) {

      console.log(&#x27;[ /users/:user_id - GET ] - return one user&#x27;);
      model.findById(req.params[indParamToGet], function(err, val) {

          if (err) {
              res.send(err);
          }

          val.name = req.body.name;
          val.firstname = req.body.firstname;
          val.email = req.body.email;

          // save the user and check for errors
          val.save(function(err) {
              if (err) {
                  res.send(err);
              }
              res.json(dm.userUpdated);
          });
      });
  });
};

var reqPatch = function(model, newRouter, indParamToGet) {
  //Update user
  newRouter.addPatch(function(req, res) {

      console.log(&#x27;[ /users/:user_id - GET ] - return one user&#x27;);
      model.findById(req.params[indParamToGet], function(err, val) {

          if (err) {
              res.send(err);
          }

          //read each key, and update the model to save it on db
          _.each( req.body, function(value, key) {

              console.log( &#x27;key : &#x27; + key + &#x27; value :&#x27; + value);
              val[key] = value;
          });

          // save the user and check for errors
          val.save(function(err) {
              if (err) {
                  res.send(err);
              }
              res.json(dm.userUpdated);
          });
      });
  });
};

var reqDelete = function(model, newRouter, indParamToGet) {
  //Update user
  newRouter.addDelete(function(req, res) {

      console.log(&#x27;[ /users/:user_id - GET ] - return one user&#x27;);
      model.remove({_id: req.params[indParamToGet]}, function(err, user) {

          if (err) {
              res.send(err);
          }
          res.json(dm.userDeleted);
      });
  });
};



/**
 * Add a route to the router
 *
 * @param {[type]} path      [description]
 * @param {[type]} nameModel [description]
 */
var addRoute = function(path, nameModel, reqNotDes, param) {

  logger.info( &quot; [ addRoute ] - new route found, path : &quot; + path );

  //retrieve the model
  var model = getModel(nameModel);

  //Create a new router
  var newRouter = new yoctoRouter(null, path);

  //Handle here requestNotDesired

  if(_.indexOf(reqNotDes, &#x27;post&#x27;) &lt; 0) {
    reqPost(model, newRouter);
  }

  if(_.indexOf(reqNotDes, &#x27;get&#x27;) &lt; 0) {
    reqGet(model, newRouter, param);
  }

  if(_.indexOf(reqNotDes, &#x27;put&#x27;) &lt; 0) {
    reqPut(model, newRouter, param);
  }

  if(_.indexOf(reqNotDes, &#x27;patch&#x27;) &lt; 0) {
    reqPatch(model, newRouter, param);
  }

  if(_.indexOf(reqNotDes, &#x27;delete&#x27;) &lt; 0) {
    reqDelete(model, newRouter, param);
  }

  if(_.indexOf(reqNotDes, &#x27;head&#x27;) &lt; 0) {
    reqHead(model, newRouter, param);
  }

  //Add the current router to the tab of router
  tabRouter.push(newRouter.router);

};


logger.info(&#x27;[ controller routes ] - start&#x27;);

// read json file and add routes
_.each(routes.routes, function(route) {

  addRoute(route.path, route.model, route.requestNotDesired, route.indexParam);

}, this);




module.exports = tabRouter;

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
