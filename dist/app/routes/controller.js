"use strict";function Controller(){this.ALL_HTTP_REQUESTS=["post","get","put","patch","delete","head"],this.models=models,this.router=express(),this.logger=logger,this.getFunctionName=function(a){return _.isUndefined(a)?"find":"findById"},this.addHTTPRequestGets=function(a,b,c,d){var e=this.getFunctionName(c);this.router[d](b,function(f,g){logger.info("[ ControllerRoutes.addHTTPRequest ] - revceiving "+d+" request, route is : "+b),a[e](f.params[c],function(a,b){a&&(console.log("err - "+a),g.send(a));"get"===d?g.json(b):g.status(200).send("OK")})})},this.addHTTPRequest=function(a,b,c,d){var e=this;this.router[d](b,function(f,g){if(logger.info("[ ControllerRoutes.addHTTPRequest ] - revceiving "+d+" request, route is : "+b),_.isEmpty(c))return void g.status(400).send("Id not defined");"delete"===d?e.deleteObject(a,g,f,c):e.updateObject(a,g,f,c,e,d)})},this.updateObject=function(a,b,c,d,e,f){a.findById(c.params[d],function(d,g){d&&b.status(400).send(d);var h=!0;_.each("put"===f?_.omit(a.schema.paths,DEFAULT_PROP_MONGODB):c.body,function(d,f){g[f]=c.body[f],_.each(_.omit(a.schema.paths,DEFAULT_PROP_MONGODB),function(a,d){_.isUndefined(c.body[d])||e.checkTypeValidation(a,c.body[d])||(b.status(400).send({error:"error type validation for key : "+d}),h=!1)}),e.checkModelValidation(d,g,f)}),h&&e.saveObject(g,b)})},this.deleteObject=function(a,b,c,d){a.remove({_id:c.params[d]},function(a,c){a&&b.status(400).send(a),b.json(dm.success)})},this.saveObject=function(a,b){a.save(function(a){a&&b.status(400).send(a),b.json(dm.success)})},this.post=function(a,b){var c=this;this.router.post(b,function(d,e){logger.info("[ ControllerRoutes.post ] - revceiving request, route is : "+b);var f=new a,g=!0;_.each(_.omit(a.schema.paths,DEFAULT_PROP_MONGODB),function(a,b){c.checkTypeValidation(a,d.body[b])||(e.status(400).send({error:"error type validation for key : "+b}),g=!1),f[b]=d.body[b],c.checkModelValidation(a,f,b)}),g&&c.saveObject(f,e)})},this.checkTypeValidation=function(a,b){var c=this.getTypeParam(b);if(_.isString(a.options.type)&&c==a.options.type.toLowerCase())return!0;if(_.isArray(a.options.type)&&"array"==c){var d=!0;if(_.each(b,function(b){return this.getTypeParam(b)!==a.options.type[0].toLowerCase()&&"string"==a.options.type[0].toLowerCase()&&"string"==this.getTypeParam(b)?(d=!1,!1):void 0},this),d)return!0}return!1},this.getTypeParam=function(a){if(_.isArray(a))return"array";try{if(a=JSON.parse(a),_.isArray(a))return"array";if(_.isString(a))return"string";if(_.isObject(a))return"object";if(_.isNumber(a))return"number"}catch(b){}try{return isObjectiId(a),"objectid"}catch(b){return"string"}},this.checkModelValidation=function(a,b,c){_.isUndefined(a.caster)||_.isUndefined(a.caster.isRequired)||b.schema.path(c).validate(function(a){return _.isEmpty(_.compact(a))?!1:void 0})},this.addRoute=function(a,b,c,d){logger.info("[ ControllerRoutes.addRoute ] - new route found, path : "+a);var e=this.models.getModel(b);return e!==!1?(logger.info("[ ControllerRoutes.addRoute ] - adding new route, path : "+a),_.each(_.difference(this.ALL_HTTP_REQUESTS,c),function(b){"patch"===b||"put"===b||"delete"===b?this.addHTTPRequest(e,a,d,b):"get"===b||"head"===b?this.addHTTPRequestGets(e,a,d,b):this[b](e,a,d)},this),!0):(logger.warning("[ ControllerRoutes.addRoute ] - can't add route : '"+a+"' ,because model is not defined"),!1)},this.addMidlleware=function(){this.router.use(function(a,b,c){logger.debug("[ ControllerRoutes.Middleware ] - incoming request"),b.header("Access-Control-Allow-Origin","*"),b.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept"),b.header("Access-Control-Allow-Methods","GET, POST, PUT, DELETE, PATCH, OPTIONS"),_.each(a.body,function(b,c){_.isEmpty(b)&&delete a.body[c]}),c()})}}var joi=require("joi"),_=require("lodash"),logger=require("yocto-logger"),express=require("express"),models=require("../models/controller.js"),dm=require("../defaultMessage.js"),fs=require("fs"),isObjectiId=require("mongoose").Types.ObjectId,DEFAULT_PROP_MONGODB=["__v","_id"],routeJoiSchema=joi.object().keys({path:joi.string().required().min(1).trim(),alias:joi.array().items(joi.string().min(1).trim()),model:joi.string().required().min(1).trim(),paramToRetrieve:joi.array().items(joi.string().min(1).trim()),requestExcluded:joi.array().items(joi.string().min(1).trim())});Controller.prototype.init=function(a,b){if(logger.debug("[ ControllerRoutes.init ] - start"),!_.isString(a)||!_.isString(b))return!1;var c={};try{fs.accessSync(a),fs.accessSync(b),c=JSON.parse(fs.readFileSync(a,"utf-8"))}catch(d){return logger.error("[ ControllerRoutes.init ] - error during loading files, more details : "+d),!1}return this.models.init(b),this.addMidlleware(),_.each(c.routes,function(a){var b=routeJoiSchema.validate(a);if(_.isEmpty(b)||_.isEmpty(b.error)){var c=[];c.push(a.path),_.isEmpty(a.alias)||(c.push(a.alias),c=_.flatten(c)),_.each(c,function(b){this.addRoute(b,a.model,a.requestExcluded,a.paramToRetrieve)},this)}else logger.error("[ ControllerRoutes.init ] - error when trying to add a new route, please check the file : 'routes.json'"),_.forEach(b.error.details,function(a){logger.warning("[ ControllerRoutes.init ] - "+a.message+" at "+a.path)})},this),!0},module.exports=new Controller;