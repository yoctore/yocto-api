"use strict";function RouteController(){this.ALL_HTTP_REQUESTS=["post","get","put","patch","delete","head"],this.models=models,this.router=express(),this.logger=logger,this.addHTTPRequestGets=function(a,b,c,d){var e=_.isUndefined(c)?"find":"findById";this.router[d](b,function(f,g){logger.debug("[ ControllerRoutes.addHTTPRequest ] - revceiving "+d+" request, route is : "+b),a[e](f.params[c],function(a,b){var c={code:200,content:{success:_.isEmpty(b)?[]:b}};return a&&(c.code=400,c.content={error:"error "+a}),"head"===d?g.status(c.code).end():void g.status(c.code).jsonp(c.content)})})},this.addHTTPRequest=function(a,b,c,d){var e=this;this.router[d](b,function(f,g){return logger.debug("[ ControllerRoutes.addHTTPRequest ] - revceiving "+d+" request, route is : "+b),_.isEmpty(c)?g.status(400).jsonp({error:"Id is not define"}):"delete"===d?e.deleteObject(a,g,f,c):e.updateObject(a,g,f,c,e,d)})},this.updateObject=function(a,b,c,d,e,f){a.findById(c.params[d],function(d,g){var h=!1,i=[],j={code:204,content:{success:"No documents found to update"}};return d?(j.code=400,j.content={error:d}):(h=!0,_.each(_.omit(a.schema.paths,DEFAULT_PROP_MONGODB),function(a,b){("patch"===f&&!_.isUndefined(c.body[b])||"put"===f)&&(g[b]=c.body[b]),_.isUndefined(c.body[b])||e.checkTypeValidation(a,c.body[b])||i.push(" "+b+" should be a : "+(_.isArray(a.options.type)?"["+a.options.type+"]":a.options.type))})),i.length>0&&(h=!1,j.code=400,j.content={error:"Error type validation for "+i.length+" key, more details : "+i}),h?e.saveObject(g,b):b.status(j.code).jsonp(j.content)})},this.deleteObject=function(a,b,c,d){a.remove({_id:c.params[d]},function(a,c){var d={code:400,content:{error:a}};a||(d.code=200,d.content={success:c+" document(s) was deleted"}),b.status(d.code).jsonp(d.content)})},this.saveObject=function(a,b){a.save(function(a){var c={code:400,content:{error:a}};a||(c.code=200,c.content={success:"Operation success"}),b.status(c.code).jsonp(c.content)})},this.post=function(a,b){var c=this;this.router.post(b,function(d,e){logger.debug("[ ControllerRoutes.post ] - revceiving request, route is : "+b);var f=new a,g=[];return _.each(_.omit(a.schema.paths,DEFAULT_PROP_MONGODB),function(a,b){_.isUndefined(d.body[b])||c.checkTypeValidation(a,d.body[b])||g.push(" "+b+" should be a "+(_.isArray(a.options.type)?"["+a.options.type+"]":a.options.type)),f[b]=d.body[b]}),_.isEmpty(g)?c.saveObject(f,e):void e.status(400).jsonp({error:"Error type validation for "+g.length+" key, more details : "+g})})},this.checkTypeValidation=function(a,b){var c=this.getTypeParam(b),d=!1;if(_.isString(a.options.type)&&c===a.options.type.toLowerCase())d=!0;else if(_.isArray(a.options.type)&&"array"===c){d=!0;var e=_.isUndefined(a.options.type[0].type)?a.options.type[0].toLowerCase():a.options.type[0].type.toLowerCase();_.each(b,function(a){this.getTypeParam(a)!==e&&"string"===e&&"string"===this.getTypeParam(a)&&(d=!1)},this)}return d},this.getTypeParam=function(a){try{var b=JSON.parse(a);return _.isArray(b)?"array":typeof b}catch(c){return logger.debug("[ ControllerRoutes.getTypeParam ] - error when parsing Param"),_.isArray(a)?"array":typeof a}},this.addRoute=function(a,b,c,d,e){logger.debug("[ ControllerRoutes.addRoute ] - new route found, path : "+a);var f=this.models.getModel(b);return f?(logger.debug("[ ControllerRoutes.addRoute ] - adding new route, path : "+a),_.each(_.difference(this.ALL_HTTP_REQUESTS,c),function(b){this[FUNC_TO_BIND[b]](f,a,d,b)},this),_.each(e.methods,function(b){try{var c=path.normalize(a+"/"+b.path);if(_.isUndefined(f.schema.methods[b.fn]))throw" Function '"+b.fn+"' not found";this.router[b.method](c,function(a,c,d){f.schema.methods[b.fn](a,c,d)})}catch(d){logger.error("[ ControllerRoutes.addRoute ] - can't add specifiq route : '"+b.sync+"' , more details : "+d)}},this),!0):(logger.error("[ ControllerRoutes.addRoute ] - can't add route : '"+a+"' ,because model is not defined"),!1)},this.addMidlleware=function(){this.router.use(function(a,b,c){b.header("Access-Control-Allow-Origin","*"),b.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept"),b.header("Access-Control-Allow-Methods","GET, POST, PUT, DELETE, PATCH, OPTIONS"),c()})}}var joi=require("joi"),_=require("lodash"),logger=require("yocto-logger"),express=require("express"),models=require("../models/controller.js"),fs=require("fs"),path=require("path"),DEFAULT_PROP_MONGODB=["__v","_id"],routeJoiSchema=joi.object().keys({path:joi.string().required().min(1).trim(),alias:joi.array().items(joi.string().min(1).trim()),model:joi.string().required().min(1).trim(),paramToRetrieve:joi.array().items(joi.string().min(1).trim().allow("post","get","put","patch","delete","head")),excluded:joi.array().items(joi.string().min(1).trim()),methods:joi.array().items(joi.object().keys({method:joi.string().required().allow("post","get","put","patch","delete","head"),path:joi.string().required().min(1),fn:joi.string().required().min(1)}))}),FUNC_TO_BIND={patch:"addHTTPRequest",put:"addHTTPRequest","delete":"addHTTPRequest",get:"addHTTPRequestGets",head:"addHTTPRequestGets",post:"post"};RouteController.prototype.init=function(a,b){logger.debug("[ ControllerRoutes.init ] - start");var c={};if(!_.isString(a)||!_.isString(b)||_.isEmpty(a)||_.isEmpty(b))return!1;try{fs.accessSync(a),fs.accessSync(b),c=JSON.parse(fs.readFileSync(a,"utf-8"))}catch(d){return logger.error("[ ControllerRoutes.init ] - error during loading files, more details : "+d),!1}return this.models.init(b),this.addMidlleware(),_.each(c.routes,function(a){var b=routeJoiSchema.validate(a);if(_.isEmpty(b)||_.isEmpty(b.error)){var c=[];c.push(a.path),_.isEmpty(a.alias)||(c.push(a.alias),c=_.flatten(c)),_.each(c,function(b){this.addRoute(b,a.model,a.excluded,a.paramToRetrieve,a)},this)}else logger.error("[ ControllerRoutes.init ] - Joi Validation failed ; error when trying to add a new route, please check the file : 'routes.json'"),_.each(b.error.details,function(a){logger.warning("[ ControllerRoutes.init ] - "+a.message+" at "+a.path)})},this),!0},module.exports=new RouteController;